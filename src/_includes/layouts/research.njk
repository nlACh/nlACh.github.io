{% extends "layouts/base.njk" %}

{% block content %}
<section class="page-section wrapper">
  <header class="page-header-section">
    <h1>{{ title }}</h1>
    <h3 class="page-intro">{{ content | safe }}</h3>
  </header>

  {# Journal Publications #}
  <section class="publications-section" id="journals">
    <h2 class="page-intro"> Journal Publications</h2>
    <div class="publications-grid">
      {% for item in collections.publication_id %}
        <article class="publication-card publication-card-horizontal">
          {% if item.data.image %}
          <div class="pub-image-side">
            <img src="/content/pub_type/1-pubs/{{ item.data.image }}" alt="Graphical abstract" loading="lazy">
          </div>
          {% endif %}
          <div class="pub-content-side">
            <h3 class="pub-title">{{ item.data.title }}</h3>
            <p class="pub-authors">{{ item.data.authors }}</p>
            <p class="pub-venue">
              <strong>{{ item.data.jorunal }}
              {% if item.data.pub_year %} ({{ item.data.pub_year }}){% endif %}</strong><br/>
              {% if item.data.doi %}
                <strong>DOI: {{ item.data.doi }}</strong>  
              {% endif %}
            </p>
            <div class="pub-actions">
              {% if item.data.doi %}
                <a href="{{ item.data.doi }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                  <span>View Paper</span>
                </a>
              {% endif %}
              {% if item.data.abstract %}
                <button class="btn btn-primary abstract-toggle" data-target="abstract-j{{ loop.index }}">
                  <span class="toggle-text">Show Abstract</span>
                </button>
              {% endif %}
            </div>
            {% if item.data.abstract %}
              <div class="pub-abstract abstract-collapsible" id="abstract-j{{ loop.index }}">
                <p>{{ item.data.abstract }}</p>
              </div>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  </section>

  {# Conference Papers #}
  <section class="publications-section" id="conferences">
    <h2 class="page-intro">Conference Papers</h2>
    <div class="publications-grid">
      {% for item in collections.conf_id %}
        <article class="publication-card publication-card-horizontal">
          {% if item.data.image %}
          <div class="pub-image-side">
            <img src="/content/pub_type/2-confs/{{ item.data.image }}" alt="Publication figure" loading="lazy">
          </div>
          {% endif %}
          <div class="pub-content-side">
            <h3 class="pub-title">{{ item.data.title }}</h3>
            <p class="pub-authors">{{ item.data.authors }}</p>
            <p class="pub-venue">
              <strong>{{ item.data.event }}</strong><br/>
              {% if item.data.doi %}
              <strong>DOI: {{ item.data.doi }}</strong>
              {% endif %}
            </p>  
            <div class="pub-actions">
              {% if item.data.proceedings %}
                <a href="{{ item.data.proceedings }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                  <span>Proceedings</span>
                </a>
              {% endif %}
              {% if item.data.presentation_file %}
                <!--
                <a href="/content/pub_type/2-confs/{{ item.data.presentation_file }}" download class="btn btn-primary">
                  Slides
                </a>
                -->
                <button class="btn btn-primary pdf-view-btn" data-pdf="/content/pub_type/2-confs/{{ item.data.presentation_file }}">
                  View Presentation
                </button>
              {% endif %}
              {% if item.data.abstract_file %}
                <!--
                <a href="/content/pub_type/2-confs/{{ item.data.abstract_file }}" download class="btn btn-outline">
                  <span>Abstract</span>
                </a>
                -->
                <button class="btn btn-primary pdf-view-btn" data-pdf="/content/pub_type/2-confs/{{ item.data.abstract_file }}">
                  View Abstract
                </button>
              {% endif %}
              {% if item.data.poster_file %}
                <button class="btn btn-primary pdf-view-btn" data-pdf="/content/pub_type/2-confs/{{ item.data.poster_file }}">
                  View Poster
                </button>
              {% endif %}
              {% if item.data.abstract %}
                <button class="btn btn-primary abstract-toggle" data-target="abstract-c{{ loop.index }}">
                  <span class="toggle-text">Show Abstract</span>
                </button>
              {% endif %}
            </div>
            {% if item.data.abstract %}
              <div class="pub-abstract abstract-collapsible" id="abstract-c{{ loop.index }}">
                <p>{{ item.data.abstract }}</p>
              </div>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  </section>

  {# Preprints #}
  <section class="publications-section" id="preprints">
    <h2 class="page-intro">Preprints</h2>
    <div class="publications-grid">
      {% for item in collections.preprint_id %}
        <article class="publication-card publication-card-horizontal">
          {% if item.data.image %}
          <div class="pub-image-side">
            <img src="/content/pub_type/3-preprints/{{ item.data.image }}" alt="Publication figure" loading="lazy">
          </div>
          {% endif %}
          <div class="pub-content-side">
            <h3 class="pub-title">{{ item.data.title }}</h3>
            <p class="pub-authors">{{ item.data.authors }}</p>
            <p class="pub-venue">Preprint {% if item.data.pub_year %}({{ item.data.pub_year }}){% endif %}</p>
            <div class="pub-actions">
              {% if item.data.preprint_addr %}
                <a href="{{ item.data.preprint_addr }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                  <span>View Preprint</span>
                </a>
              {% endif %}
              {% if item.data.alt_available == "Yes" and item.data.alt_addr %}
                <a href="{{ item.data.alt_addr }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                  <span>Alternative Link</span>
                </a>
              {% endif %}
              {% if item.data.abstract %}
                <button class="btn btn-primary abstract-toggle" data-target="abstract-p{{ loop.index }}">
                  <span class="toggle-text">Show Abstract</span>
                </button>
              {% endif %}
            </div>
            {% if item.data.abstract %}
              <div class="pub-abstract abstract-collapsible" id="abstract-p{{ loop.index }}">
                <p>{{ item.data.abstract }}</p>
              </div>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  </section>
</section>

{# PDF Modal #}
<div class="pdf-modal" id="pdfModal">
  <div class="pdf-modal-backdrop"></div>
  <div class="pdf-modal-content">
    <button class="pdf-modal-close" aria-label="Close modal">&times;</button>
    <iframe id="pdfViewer" src="" title="PDF Viewer"></iframe>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const abstractToggles = document.querySelectorAll('.abstract-toggle');
  abstractToggles.forEach(function(btn) {
    btn.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const target = document.getElementById(targetId);
      const toggleText = this.querySelector('.toggle-text');
      
      if (target) {
        const isExpanded = target.classList.contains('abstract-expanded');
        
        if (isExpanded) {
          target.classList.remove('abstract-expanded');
          this.classList.remove('active');
          if (toggleText) toggleText.textContent = 'Show Abstract';
        } else {
          target.classList.add('abstract-expanded');
          this.classList.add('active');
          if (toggleText) toggleText.textContent = 'Hide Abstract';
        }
      }
    });
  });

  // PDF Modal functionality
  const pdfModal = document.getElementById('pdfModal');
  const pdfViewer = document.getElementById('pdfViewer');
  const pdfViewBtns = document.querySelectorAll('.pdf-view-btn');
  const pdfModalBackdrop = pdfModal.querySelector('.pdf-modal-backdrop');
  const pdfModalClose = pdfModal.querySelector('.pdf-modal-close');

  function openPdfModal(pdfUrl) {
    pdfViewer.src = pdfUrl;
    pdfModal.classList.add('pdf-modal-open');
    document.body.style.overflow = 'hidden';
  }

  function closePdfModal() {
    pdfModal.classList.remove('pdf-modal-open');
    pdfViewer.src = '';
    document.body.style.overflow = '';
  }

  pdfViewBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      const pdfUrl = this.getAttribute('data-pdf');
      if (pdfUrl) {
        openPdfModal(pdfUrl);
      }
    });
  });

  if (pdfModalBackdrop) {
    pdfModalBackdrop.addEventListener('click', closePdfModal);
  }

  if (pdfModalClose) {
    pdfModalClose.addEventListener('click', closePdfModal);
  }

  // Abstract Modal functionality
  const abstractModal = document.getElementById('abstractModal');
  const abstractModalTitle = document.getElementById('abstractModalTitle');
  const abstractModalText = document.getElementById('abstractModalText');
  const abstractModalBtns = document.querySelectorAll('.abstract-modal-btn');
  const abstractModalBackdrop = abstractModal.querySelector('.abstract-modal-backdrop');
  const abstractModalClose = abstractModal.querySelector('.abstract-modal-close');

  function openAbstractModal(title, abstractText) {
    // Decode HTML entities
    const textarea = document.createElement('textarea');
    textarea.innerHTML = abstractText;
    const decodedAbstract = textarea.value;
    
    abstractModalTitle.textContent = title;
    abstractModalText.textContent = decodedAbstract;
    abstractModal.classList.add('abstract-modal-open');
    document.body.style.overflow = 'hidden';
    
    // Focus on close button for accessibility
    abstractModalClose.focus();
  }

  function closeAbstractModal() {
    abstractModal.classList.remove('abstract-modal-open');
    document.body.style.overflow = '';
  }

  abstractModalBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      const title = this.getAttribute('data-title');
      const abstractText = this.getAttribute('data-abstract');
      if (title && abstractText) {
        openAbstractModal(title, abstractText);
      }
    });
  });

  if (abstractModalBackdrop) {
    abstractModalBackdrop.addEventListener('click', closeAbstractModal);
  }

  if (abstractModalClose) {
    abstractModalClose.addEventListener('click', closeAbstractModal);
  }

  // Close modals on ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (pdfModal.classList.contains('pdf-modal-open')) {
        closePdfModal();
      }
      if (abstractModal.classList.contains('abstract-modal-open')) {
        closeAbstractModal();
      }
    }
  });
});
</script>
{% endblock %}
